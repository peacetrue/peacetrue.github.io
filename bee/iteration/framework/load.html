<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>负载测试 :: 安宁的知识库</title>
    <link rel="canonical" href="https://peacetrue.github.io/bee/iteration/framework/load.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://peacetrue.github.io">安宁的知识库</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="bee" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all"></button>
    <h3 class="title"><a href="../../index.html">开发者助手</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../index.html">简介</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../developer.html">开发者手册</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../version.html">版本变更</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">基础框架</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="architecture.html">架构</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="frontend.html">前端项目</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="backend.html">后端项目</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="load.html">负载测试</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">数据转换</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../conversion/requirement.html">需求</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../conversion/function.html">功能</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../conversion/design.html">设计</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../conversion/api.html">接口</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">开发者助手</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../peacetrue-shell/index.html">Shell 脚本库</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../peacetrue-shell/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../peacetrue-common/index.html">公共组件</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../peacetrue-common/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../peacetrue-result/index.html">响应结果组件</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../peacetrue-result/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../learn-asciidoc/index.html">学习 AsciiDoc</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../learn-asciidoc/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../learn-c/index.html">学习 C 语言</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../learn-c/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../learn-lldb/index.html">学习 LLDB</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../learn-lldb/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../peacetrue-cryptography/index.html">密码学组件</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../peacetrue-cryptography/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../index.html">开发者助手</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../overview/index.html">总览</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../overview/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../peacetrue-test/index.html">测试组件</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../peacetrue-test/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../peacetrue-beans/index.html">简单 Java 对象</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../peacetrue-beans/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../overview/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">开发者助手</a></li>
    <li>基础框架</li>
    <li><a href="load.html">负载测试</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/peacetrue/bee/edit/master/docs/antora/modules/ROOT/pages/iteration/framework/load.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">负载测试</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>本文将使用 <a href="https://jmeter.apache.org/">JMeter</a> 5.4.1 测试网站的最佳负载情况。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_概述"><a class="anchor" href="#_概述"></a>1. 概述</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_注意事项"><a class="anchor" href="#_注意事项"></a>1.1. 注意事项</h3>
<div class="paragraph">
<p>请求必须设置连接超时和响应超时，
否则有些连接一直未完成，
导致整个测试计划不能退出，无法生成测试报告。
连接超时一般设置为 500 毫秒，能连上的差不多就连上了，连不上的再多时间也还是不行；
响应超时一般设置为 3000 毫秒，能返回数据的差不多就返回了，返回不了的再多时间也还是不行。</p>
</div>
<div class="paragraph">
<p>本机压测必须勾选 keepalive 选项，
否则线程在频繁创建连接时，
相互之间可能存在冲突，
会导致连接超时问题。</p>
</div>
<div class="paragraph">
<p>测试时间较短时，执行相同的测试，
可能得到不同的测试结果，且差距较大。</p>
</div>
</div>
<div class="sect2">
<h3 id="_测试方案"><a class="anchor" href="#_测试方案"></a>1.2. 测试方案</h3>
<div class="paragraph">
<p>先使用较短的时间，快速测试网站的整体性能，
找出大概范围后，再加长时间测试出更为准确的值。</p>
</div>
<div class="paragraph">
<p>一般从 0 开始，每秒增加一个线程，增加到 600，持续 700 秒。
观察此过程中，什么时间点 TPS 达到最高。
找到时间点对应的线程数 <strong>n</strong>，
然后从 <strong>n-10</strong> 开始，600 秒内，
增加到 <strong>n+10</strong>，持续 700 秒。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
如果一直是升高的趋势，则表明 TPS 尚未达到峰值，需要增加线程数。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_具体操作"><a class="anchor" href="#_具体操作"></a>1.3. 具体操作</h3>
<div class="paragraph">
<p>使用 GUI 模式设计测试计划，使用 NON_GUI 运行负载测试。
为了方便调整负载测试的属性，设计了一些变量：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/image-2022-09-06-17-24-40-094.png" alt="image 2022 09 06 17 24 40 094">
</div>
<div class="title">Figure 1. 超时时间</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/image-2022-08-23-06-51-54-752.png" alt="image 2022 08 23 06 51 54 752">
</div>
<div class="title">Figure 2. 线程组</div>
</div>
<div class="paragraph">
<p>变量说明如下：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">属性名</th>
<th class="tableblock halign-left valign-top">默认值</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">连接超时（毫秒）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">响应超时（毫秒）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">responseTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3000</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">线程数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">threadCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">加速周期（秒）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rampUpSeconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">循环次数</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">loopCount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">整形，最大值 2147483647</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">持续时间（秒）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">durationSeconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">启动延迟（秒）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">startupDelaySeconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>GUI 模式下，只需要运行 1 次，确认请求调用正常。
NON_GUI 模式下，通过配置文件设置变量值。</p>
</div>
<div class="paragraph">
<p>执行测试计划时，指定属性配置文件 <strong>options.properties：</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">jmeter -n -t test-plan.jmx -q options.properties -l result.csv -e -o report</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>options.properties</strong> 文件内容如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-properties hljs" data-lang="properties"># 600 秒内启动 600 个线程，每秒增加 1 个线程，持续 700 秒
threadCount=600
rampUpSeconds=600
loopCount=2147483647
durationSeconds=700
startupDelaySeconds=1
connectTimeout=500
responseTimeout=3000</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_服务器环境"><a class="anchor" href="#_服务器环境"></a>2. 服务器环境</h2>
<div class="sectionbody">
<div class="paragraph">
<p>阿里云 ECS：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/image-2022-09-06-20-02-17-929.png" alt="image 2022 09 06 20 02 17 929">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Ubuntu 22.04 64位</p>
</li>
<li>
<p>4 核 8 GiB</p>
</li>
<li>
<p>按量付费 100 Mbps 宽带</p>
</li>
<li>
<p>openjdk-17-jre-headless</p>
</li>
<li>
<p>nginx/1.18.0</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>宽带如果不够，会导致性能低下，这里备足宽带。</p>
</div>
<div class="paragraph">
<p>测试地址：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nginx 首页： <a href="http://peacetrue.cn" class="bare">http://peacetrue.cn</a></p>
</li>
<li>
<p>Bee 项目前端首页： <a href="http://bee.peacetrue.cn" class="bare">http://bee.peacetrue.cn</a></p>
</li>
<li>
<p>Bee 项目后端健康检查端点：</p>
<div class="ulist">
<ul>
<li>
<p>直接访问： <a href="http://peacetrue.cn:8081/actuator/health" class="bare">http://peacetrue.cn:8081/actuator/health</a></p>
</li>
<li>
<p>Nginx 转发： <a href="http://bee.peacetrue.cn/api/actuator/health" class="bare">http://bee.peacetrue.cn/api/actuator/health</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nginx_首页"><a class="anchor" href="#_nginx_首页"></a>3. Nginx 首页</h2>
<div class="sectionbody">
<div class="paragraph">
<p>使用 Nginx 默认配置，测试 Nginx 首页性能。</p>
</div>
<div class="listingblock">
<div class="title">Nginx 默认配置</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-conf hljs" data-lang="conf">user www-data;
worker_processes auto;
pid /run/nginx.pid;

# 动态加载监控模块
load_module /etc/nginx/modules/ngx_http_vhost_traffic_status_module.so;

include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
	# multi_accept on;
}


http {
	# 启用监控模块
	vhost_traffic_status_zone;

	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on;
	types_hash_max_size 2048;
	# server_tokens off;

	# server_names_hash_bucket_size 64;
	# server_name_in_redirect off;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	##
	# Gzip Settings
	##

	gzip on;

	# gzip_vary on;
	# gzip_proxied any;
	# gzip_comp_level 6;
	# gzip_buffers 16 8k;
	# gzip_http_version 1.1;
	# gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	##
	# Virtual Host Configs
	##

	include /etc/nginx/conf.d/*.conf;
	include /etc/nginx/sites-enabled/*;
}


#mail {
#	# See sample authentication script at:
#	# http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
#
#	# auth_http localhost/auth.php;
#	# pop3_capabilities "TOP" "USER";
#	# imap_capabilities "IMAP4rev1" "UIDPLUS";
#
#	server {
#		listen     localhost:110;
#		protocol   pop3;
#		proxy      on;
#	}
#
#	server {
#		listen     localhost:143;
#		protocol   imap;
#		proxy      on;
#	}
#}</code></pre>
</div>
</div>
<div class="paragraph">
<p>启动 Nginx 观察其进程情况：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ ps -ef | grep nginx | grep -v grep
root      184204       1  0 02:25 ?        00:00:00 nginx: master process nginx
www-data  184205  184204  1 02:25 ?        00:00:23 nginx: worker process
www-data  184206  184204  0 02:25 ?        00:00:04 nginx: worker process
www-data  184207  184204  0 02:25 ?        00:00:00 nginx: worker process
www-data  184208  184204  0 02:25 ?        00:00:00 nginx: worker process</code></pre>
</div>
</div>
<div class="paragraph">
<p>1 个主进程，4 个工作进程，工作进程数目等于 CPU 核心数。</p>
</div>
<div class="paragraph">
<p>使用 600 个线程：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-properties hljs" data-lang="properties"># 600 秒内启动 600 个线程，每秒增加 1 个线程，持续 700 秒
threadCount=600
rampUpSeconds=600
loopCount=2147483647
durationSeconds=700
startupDelaySeconds=1
connectTimeout=500
responseTimeout=3000</code></pre>
</div>
</div>
<div class="paragraph">
<p>执行测试：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">jmeter -n -t nginx.jmx -q nginx.properties -l nginx.csv -e -o nginx</code></pre>
</div>
</div>
<div class="paragraph">
<p>测试报告如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/image-2022-09-06-19-46-36-246.png" alt="image 2022 09 06 19 46 36 246">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/image-2022-09-06-19-47-34-750.png" alt="image 2022 09 06 19 47 34 750">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/image-2022-09-06-19-56-01-590.png" alt="image 2022 09 06 19 56 01 590">
</div>
</div>
<div class="paragraph">
<p>worker_connections 为 768，则 4 * 768 = 3072。</p>
</div>
<div class="paragraph">
<p>查看进程打开的文件描述符限制：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">$ ulimit -n
65535</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_连接超时问题排查"><a class="anchor" href="#_连接超时问题排查"></a>3.1. 连接超时问题排查</h3>
<div class="paragraph">
<p>整个网络通信过程如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/network.png" alt="network">
</div>
</div>
<div class="paragraph">
<p>各个步骤都可能出现问题，宽带也可能存在问题。</p>
</div>
<div class="paragraph">
<p>也可以通过命令查看 <a href="https://cloud.tencent.com/developer/article/1430275" target="_blank" rel="noopener">网络宽带</a>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">apt-get install nload -y
nload</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bee_主应用"><a class="anchor" href="#_bee_主应用"></a>4. Bee 主应用</h2>
<div class="sectionbody">
<div class="paragraph">
<p>使用健康检查接口，测试 Bee 的性能。</p>
</div>
<div class="paragraph">
<p>健康检查接口的地址如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tomcat：http://peacetrue.cn:8080/actuator/health</p>
</li>
<li>
<p>Nginx ：http://bee.peacetrue.cn/api/actuator/health</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_tomcat_9"><a class="anchor" href="#_tomcat_9"></a>4.1. Tomcat 9</h3>
<div class="paragraph">
<p>Bee 使用 Tomcat 9 作为 Web 服务器，
初始 Tomcat 使用默认的配置，后续根据测试结果调整。</p>
</div>
<div class="paragraph">
<p>使用如下 JMeter 配置属性：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-properties hljs" data-lang="properties"># 300 秒内启动 300 个线程，每秒增加 1 个线程，持续 400 秒
threadCount=300
rampUpSeconds=300
loopCount=2147483647
durationSeconds=400
startupDelaySeconds=1
connectTimeout=1000
responseTimeout=3000</code></pre>
</div>
</div>
<div class="paragraph">
<p>执行测试计划：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-bash hljs" data-lang="bash">jmeter -n -t test-plan.jmx -q options.properties -l result.csv -e -o report</code></pre>
</div>
</div>
<div class="paragraph">
<p>得到测试结果：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/test/image-2022-08-23-20-10-09-469.png" alt="image 2022 08 23 20 10 09 469">
</div>
</div>
<div class="paragraph">
<p>观察发现，错误率比较高，主要是
<code>ConnectTimeoutException</code> 和 <code>SocketTimeoutException</code>。</p>
</div>
<div class="paragraph">
<p>查看服务器日志，没有发现错误日志。
客户端发生错误，服务端却没有体现，是什么原因？</p>
</div>
<div class="paragraph">
<p><code>ConnectTimeoutException</code> 可能是达到了连接数上限。</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
